<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>~clicky?</title>
        <style> 
	        *{ 
	        	margin: 0; 
	        	font-family: 'Monaco', 'Menlo', monospace;
	        }
	        canvas{ 
	        	vertical-align: top;
	        	background: white; 
	        	transition: opacity 500ms;
	        }
	        #stamp{
	        	position: fixed;
	        	top: 0;
	        	left: 0;
	        	width: 100%;
	        	height: 100%;
	        	background: white;
	        	opacity: 0;
	        	transition: opacity 600ms;
	        }
	        #help{
	        	position: fixed;
	        	color: blue;
	        	top: 100px;
	        	left: 50px;
	        	font-size: 14px;
	        	text-shadow: 0px 0px 20px white;
	        	pointer-events: none;
	        	transition: opacity 800ms;
	        }
        </style>
    </head>
    <body>
    	<canvas id="main"></canvas>
    	<canvas id="stamp"></canvas>
    	<div id="help">
    		<p>1 = view background</p>
    		<p>2 = view stamp editor</p>
    		<p>3 = toggle leaf/flower</p>
    		<p>left/right = cycle colours</p>
    	</div>
	    <script>

    ///////////////////////////////////////////////////////////////////////////////////////////// VARIABLES / SETUP

        	// main canvas
        	var canvas = document.getElementById("main");
			var c = canvas.getContext("2d");
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;

			// pattern canvas
			var pCanvas = document.createElement("canvas");
			var pc = pCanvas.getContext("2d");
			pCanvas.width = canvas.width/5; 
			pCanvas.height = canvas.height/5;

			// stamp canvas
			var sCanvas = document.getElementById("stamp");
			var sc = sCanvas.getContext("2d");
			sCanvas.width = canvas.width; 
			sCanvas.height = canvas.height;

			var hideCanvas = false;
			var hideControls = true;
			var drawingEnabled = true;
			var toggleFlower = false;

	///////////////////////////////////////////////////////////////////////////////////////////// COLOUR

			var getRandomColour = function(){
				red = Math.round(Math.random()*255);
				green = Math.round(Math.random()*255);
				blue = Math.round(Math.random()*255);
				return 'rgba('+ red +','+ green +','+ blue + ',1)';
			}

	///////////////////////////////////////////////////////////////////////////////////////////// PATTERN


			var patternCanvas = function(){
				pc.drawImage(canvas, 0, 0, pCanvas.width, pCanvas.height);
				document.body.style.background = 'url('+ pCanvas.toDataURL() +')';
			}

	///////////////////////////////////////////////////////////////////////////////////////////// DRAW (on click)

			var bs = 300;
			var cPos = 0;
			var colours = [ getRandomColour(), getRandomColour(), getRandomColour(), getRandomColour(), getRandomColour() ];
			var colour = colours[cPos];

			var draw = function(e){
				if(drawingEnabled){

					getBlendMode();

					w = canvas.width;
					h = canvas.height;
					x = e.offsetX; 
					y = e.offsetY;

					xOver = x + (bs/2) > w;
					xUnder = x - (bs/2) < bs;
					yOver = y + (bs/2) > h;
					yUnder = y - (bs/2) < bs;

					if(xOver){
						wrapStamp(x-w, y);
					}
					if(xUnder){
						wrapStamp(x+w, y);
					}
					if(yOver){
						wrapStamp(x, y-h);
					}
					if(yUnder){
						wrapStamp(x, y+h);
					}
					if(xOver && yOver){
						wrapStamp(x-w, y-h);
					}
					if(xOver && yUnder){
						wrapStamp(x-w, y+h);
					}
					if(xUnder && yOver){
						wrapStamp(x+w, y-h);
					}
					if(xUnder && yUnder){
						wrapStamp(x+w, y+h);
					}
					wrapStamp(x, y);

					patternCanvas();
				}
			}

	///////////////////////////////////////////////////////////////////////////////////////////// WRAP

			var wrapStamp = function(xPos, yPos){
				c.save();
				c.translate(xPos, yPos);
				box( colour, bs);
				c.restore();
			}

	///////////////////////////////////////////////////////////////////////////////////////////// FLOWER

			var flower = function(colour, size){
				var fCanvas = document.createElement("canvas");
				var fc = fCanvas.getContext("2d");
				fCanvas.width = bs; 
				fCanvas.height = bs;

				petalCount = Math.round(Math.random()*(8-5)+5);
				petalAngle = 360/petalCount;

				console.log(petalCount);

				xOffset = Math.random()*( (size*0.4)-(size*0.1)) + (size*0.1);
				yOffset = Math.random()*( (size*0.3)-(size*0.1)) + (size*0.1);

				fc.fillStyle = colour;

				for(i=0; i<petalCount; i++){
					fc.save();
					fc.translate(size/2, size/2);
					fc.rotate( petalAngle*i * Math.PI/180);
					fc.beginPath();
					fc.moveTo(0, 0);
					fc.quadraticCurveTo(-xOffset, yOffset, 0, size/2);
					fc.quadraticCurveTo(xOffset, yOffset, 0, 0);
					fc.fill();
					fc.closePath();
					fc.restore();
				}

				c.drawImage(fCanvas, -size/2, -size/2, fCanvas.width, fCanvas.height);
			}

	///////////////////////////////////////////////////////////////////////////////////////////// BOX

			var box = function(colour, size){
				c.fillStyle = colour;
				if(toggleFlower){
					//leaf
					c.fillRect( -size/2, -size/2, size, size );
				}else{
					//flower
					// c.beginPath();
					// c.arc(0, 0, size[0]/2, 0, 2 * Math.PI);
					// c.fill();
					// c.closePath();
					flower(colour, size);
				}
			}

			var getBlendMode = function(){
				if(Math.random()>0.5){
					c.globalCompositeOperation = 'multiply';
				}else{
					c.globalCompositeOperation = 'screen';
				}
			}


	///////////////////////////////////////////////////////////////////////////////////////////// KEYPRESS
			var keyPress = function(e){
				console.log(e);

				// 1 : toggle background
				if(e.keyIdentifier == "U+0031"){
					hideCanvas=!hideCanvas;
					if(hideCanvas){
						drawingEnabled = false;
						canvas.style.opacity = '0';
					}else{
						drawingEnabled = true;
						canvas.style.opacity = '1';
					}
				}

				// 2 : toggle controls
				if(e.keyIdentifier == "U+0032"){
					hideControls=!hideControls;
					if(hideControls){
						drawingEnabled = true;
						sCanvas.style.opacity = '0';
					}else{
						drawingEnabled = false;
						sCanvas.style.opacity = '0.9';
					}
				}

				// 3 : toggle flower/leaf
				if(e.keyIdentifier == "U+0033"){
					toggleFlower=!toggleFlower;
					console.log(toggleFlower);
				}


				// U/D : size
				if(e.keyIdentifier == "Up"){
					console.log("Up");
					bs += 10;
					if(bs >= 500) bs = 500;	
					drawStamp();
				}
				if(e.keyIdentifier == "Down"){
					console.log("Down");
					bs -= 10;
					if(bs <= 10) bs = 10;
					drawStamp();
				}

				// L/R : colours
				if(e.keyIdentifier == "Left"){
					console.log("Left");
					cPos -= 1; 
					if(cPos < 0) cPos = colours.length-1; 
					console.log(cPos);
					console.log(colours.length);
				}
				if(e.keyIdentifier == "Right"){
					console.log("Right");
					cPos += 1; 
					if(cPos >= colours.length) cPos = 0; 
				}

				// H : hide lexicon
				if(e.keyIdentifier == "U+0048"){
					toggleHelp=!toggleHelp; 

				}

				// C : clear canvas
				if(e.keyIdentifier == "U+0043"){
					c.clearRect(0, 0, canvas.width, canvas.height);
				}

				colour = colours[cPos];
				drawStamp();
			}

			var drawStamp = function(){
				sc.fillStyle = "white";
				sc.fillRect(0, 0, sCanvas.width, sCanvas.height);
				sc.fillStyle = colour;

				if(toggleFlower){
					sc.fillRect( (sCanvas.width/2)-(bs/2), (sCanvas.height/2)-(bs/2), bs, bs);
				}else{
					sc.beginPath();
					sc.arc( sCanvas.width/2, sCanvas.height/2, bs/2, 0, 2 * Math.PI );
					sc.fill();
					sc.closePath();
				}
			}

			window.onkeydown = keyPress;
			window.onclick = draw;

        </script>
    </body>
</html>